{% extends 'base.html' %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <h1 class="mb-3">Dashboard</h1>
        
        <div class="alert alert-primary">
            <div class="d-flex align-items-center">
                <div class="me-3">
                    <i class="fas fa-info-circle fa-2x"></i>
                </div>
                <div>
                    <h4 class="alert-heading mb-1">Willkommen bei VMware vSphere Reporter v29.0</h4>
                    <p class="mb-0">Überblicken Sie Ihre vSphere-Umgebung und generieren Sie detaillierte Berichte über VMware Tools Status, VM-Snapshots und verwaiste VMDKs.</p>
                </div>
            </div>
        </div>
    </div>
</div>

{% if demo_mode %}
<div class="alert alert-warning mb-4">
    <div class="d-flex align-items-center">
        <div class="me-3">
            <i class="fas fa-flask fa-2x"></i>
        </div>
        <div>
            <h4 class="alert-heading mb-1">Demo-Modus aktiv</h4>
            <p class="mb-0">
                Sie arbeiten mit simulierten Beispieldaten. Diese Daten spiegeln keine echte vSphere-Umgebung wider.
                <a href="{{ url_for('index') }}" class="alert-link">Klicken Sie hier</a>, um sich mit einem echten vCenter Server zu verbinden.
            </p>
        </div>
    </div>
</div>
{% endif %}

<!-- Status-Karten für Hauptinformationen -->
<div class="row mb-4">
    <!-- VMware Tools Status -->
    <div class="col-md-4 mb-4">
        <div class="card h-100">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <span><i class="fas fa-tools"></i> VMware Tools Status</span>
                {% if vmware_tools %}
                {% set ok_count = vmware_tools|selectattr("tools_status", "eq", "toolsOk")|list|length %}
                {% set total_count = vmware_tools|length %}
                {% set percentage = (ok_count / total_count) * 100 %}
                    {% if percentage >= 90 %}
                    <span class="badge bg-success">Gut</span>
                    {% elif percentage >= 70 %}
                    <span class="badge bg-warning">Mittel</span>
                    {% else %}
                    <span class="badge bg-danger">Kritisch</span>
                    {% endif %}
                {% endif %}
            </div>
            <div class="card-body">
                {% if vmware_tools %}
                    {% set ok_count = vmware_tools|selectattr("tools_status", "eq", "toolsOk")|list|length %}
                    {% set old_count = vmware_tools|selectattr("tools_status", "eq", "toolsOld")|list|length %}
                    {% set not_installed_count = vmware_tools|selectattr("tools_status", "eq", "toolsNotInstalled")|list|length %}
                    {% set not_running_count = vmware_tools|selectattr("tools_status", "eq", "toolsNotRunning")|list|length %}
                    {% set total_count = vmware_tools|length %}
                    
                    <div class="d-flex justify-content-between mb-2">
                        <span>Aktuelle Version:</span>
                        <span class="fw-bold text-success">{{ ok_count }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Veraltet:</span>
                        <span class="fw-bold text-warning">{{ old_count }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Nicht installiert:</span>
                        <span class="fw-bold text-danger">{{ not_installed_count }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <span>Nicht ausgeführt:</span>
                        <span class="fw-bold text-secondary">{{ not_running_count }}</span>
                    </div>
                    
                    <div class="progress mb-3" style="height: 20px;">
                        <div class="progress-bar bg-success" role="progressbar" style="width: {{ (ok_count / total_count) * 100 }}%;">
                            {{ ((ok_count / total_count) * 100)|round|int }}%
                        </div>
                        <div class="progress-bar bg-warning" role="progressbar" style="width: {{ (old_count / total_count) * 100 }}%;">
                            {{ ((old_count / total_count) * 100)|round|int }}%
                        </div>
                        <div class="progress-bar bg-danger" role="progressbar" style="width: {{ (not_installed_count / total_count) * 100 }}%;">
                            {{ ((not_installed_count / total_count) * 100)|round|int }}%
                        </div>
                        <div class="progress-bar bg-secondary" role="progressbar" style="width: {{ (not_running_count / total_count) * 100 }}%;">
                            {{ ((not_running_count / total_count) * 100)|round|int }}%
                        </div>
                    </div>
                {% else %}
                    <p class="text-muted">Keine Daten verfügbar.</p>
                {% endif %}
                
                <a href="{{ url_for('vmware_tools') }}" class="btn btn-primary w-100">
                    <i class="fas fa-search"></i> Details anzeigen
                </a>
            </div>
        </div>
    </div>
    
    <!-- Snapshots -->
    <div class="col-md-4 mb-4">
        <div class="card h-100">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <span><i class="fas fa-camera"></i> Snapshots</span>
                {% if snapshots %}
                {% set critical_count = 0 %}
                {% for snapshot in snapshots %}
                    {% set days = (now - snapshot.create_time).days %}
                    {% if days > 30 %}
                        {% set critical_count = critical_count + 1 %}
                    {% endif %}
                {% endfor %}
                    {% if critical_count == 0 %}
                    <span class="badge bg-success">Gut</span>
                    {% elif critical_count <= 2 %}
                    <span class="badge bg-warning">Mittel</span>
                    {% else %}
                    <span class="badge bg-danger">Kritisch</span>
                    {% endif %}
                {% endif %}
            </div>
            <div class="card-body">
                {% if snapshots %}
                    {% set critical_snapshots = 0 %}
                    {% set warning_snapshots = 0 %}
                    {% set ok_snapshots = 0 %}
                    {% for snapshot in snapshots %}
                        {% set days = (now - snapshot.create_time).days %}
                        {% if days > 30 %}
                            {% set critical_snapshots = critical_snapshots + 1 %}
                        {% elif days > 7 %}
                            {% set warning_snapshots = warning_snapshots + 1 %}
                        {% else %}
                            {% set ok_snapshots = ok_snapshots + 1 %}
                        {% endif %}
                    {% endfor %}
                    {% set total_snapshots = snapshots|length %}
                    
                    <div class="d-flex justify-content-between mb-2">
                        <span>Gesamtzahl Snapshots:</span>
                        <span class="fw-bold">{{ total_snapshots }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Kritisch (> 30 Tage):</span>
                        <span class="fw-bold text-danger">{{ critical_snapshots }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Warnung (7-30 Tage):</span>
                        <span class="fw-bold text-warning">{{ warning_snapshots }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <span>OK (< 7 Tage):</span>
                        <span class="fw-bold text-success">{{ ok_snapshots }}</span>
                    </div>
                    
                    {% if snapshots|length > 0 %}
                        {% set oldest_snapshot = snapshots|sort(attribute='create_time')|first %}
                        {% set oldest_days = (now - oldest_snapshot.create_time).days %}
                        <div class="alert {% if oldest_days > 30 %}alert-danger{% elif oldest_days > 7 %}alert-warning{% else %}alert-success{% endif %} mb-3">
                            <strong>Ältester Snapshot:</strong> {{ oldest_days }} Tage
                        </div>
                    {% endif %}
                {% else %}
                    <p class="text-muted">Keine Daten verfügbar.</p>
                {% endif %}
                
                <a href="{{ url_for('snapshots') }}" class="btn btn-primary w-100">
                    <i class="fas fa-search"></i> Details anzeigen
                </a>
            </div>
        </div>
    </div>
    
    <!-- Verwaiste VMDKs -->
    <div class="col-md-4 mb-4">
        <div class="card h-100">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <span><i class="fas fa-hdd"></i> Verwaiste VMDKs</span>
                {% if orphaned_vmdks %}
                    {% if orphaned_vmdks|length == 0 %}
                    <span class="badge bg-success">Gut</span>
                    {% elif orphaned_vmdks|length <= 5 %}
                    <span class="badge bg-warning">Mittel</span>
                    {% else %}
                    <span class="badge bg-danger">Kritisch</span>
                    {% endif %}
                {% endif %}
            </div>
            <div class="card-body">
                {% if orphaned_vmdks %}
                    {% set total_vmdks = orphaned_vmdks|length %}
                    
                    {% set total_size = 0 %}
                    {% for vmdk in orphaned_vmdks %}
                        {% set total_size = total_size + vmdk.size_bytes|default(0) %}
                    {% endfor %}
                    {% set total_size_gb = total_size / 1073741824 %}
                    
                    {% set datastores = {} %}
                    {% for vmdk in orphaned_vmdks %}
                        {% if vmdk.datastore in datastores %}
                            {% set _ = datastores.update({vmdk.datastore: datastores[vmdk.datastore] + 1}) %}
                        {% else %}
                            {% set _ = datastores.update({vmdk.datastore: 1}) %}
                        {% endif %}
                    {% endfor %}
                    
                    <div class="d-flex justify-content-between mb-2">
                        <span>Anzahl verwaister VMDKs:</span>
                        <span class="fw-bold text-danger">{{ total_vmdks }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Verschwendeter Speicherplatz:</span>
                        <span class="fw-bold text-warning">{{ total_size_gb|round(1) }} GB</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <span>Betroffene Datastores:</span>
                        <span class="fw-bold">{{ datastores|length }}</span>
                    </div>
                    
                    {% if datastores|length > 0 %}
                        <div class="alert alert-info mb-3">
                            <strong>Hauptsächlich betroffen:</strong> 
                            {% set top_datastore = datastores.items()|sort(reverse=True, attribute='1')|first %}
                            {{ top_datastore[0] }} ({{ top_datastore[1] }} VMDKs)
                        </div>
                    {% endif %}
                {% else %}
                    <p class="text-muted">Keine Daten verfügbar.</p>
                {% endif %}
                
                <a href="{{ url_for('orphaned_vmdks') }}" class="btn btn-primary w-100">
                    <i class="fas fa-search"></i> Details anzeigen
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Umgebungsübersicht -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <i class="fas fa-server"></i> Umgebungsübersicht
            </div>
            <div class="card-body">
                <div class="row">
                    {% if vms %}
                    <div class="col-md-3 mb-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="fas fa-laptop fa-3x text-primary mb-3"></i>
                                <h3>{{ vms|length }}</h3>
                                <p class="card-text">Virtuelle Maschinen</p>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if hosts %}
                    <div class="col-md-3 mb-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="fas fa-server fa-3x text-primary mb-3"></i>
                                <h3>{{ hosts|length }}</h3>
                                <p class="card-text">ESXi Hosts</p>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if datastores %}
                    <div class="col-md-3 mb-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="fas fa-hdd fa-3x text-primary mb-3"></i>
                                <h3>{{ datastores|length }}</h3>
                                <p class="card-text">Datastores</p>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if networks %}
                    <div class="col-md-3 mb-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="fas fa-network-wired fa-3x text-primary mb-3"></i>
                                <h3>{{ networks|length }}</h3>
                                <p class="card-text">Netzwerke</p>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Berichterstellung -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <i class="fas fa-file-export"></i> Berichterstellung
            </div>
            <div class="card-body">
                <p>Generieren Sie einen umfassenden Bericht Ihrer vSphere-Umgebung in verschiedenen Formaten.</p>
                <a href="{{ url_for('generate_report') }}" class="btn btn-primary">
                    <i class="fas fa-file-export"></i> Bericht generieren
                </a>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    $(document).ready(function() {
        // Tooltips initialisieren
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    });
</script>
{% endblock %}