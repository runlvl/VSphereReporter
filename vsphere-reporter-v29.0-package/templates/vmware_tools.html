{% extends 'base.html' %}

{% block content %}
<h1><i class="fas fa-tools"></i> VMware Tools Status</h1>

<div class="content-section">
    <p class="lead">Übersicht über den Status der VMware Tools auf allen virtuellen Maschinen.</p>
    
    <div class="row mb-3">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-info-circle"></i> Informationen zum VMware Tools Status</span>
                        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#toolsInfoCollapse">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                    </div>
                </div>
                <div class="collapse" id="toolsInfoCollapse">
                    <div class="card-body">
                        <p>VMware Tools ist ein Satz von Dienstprogrammen und Treibern, die die Leistung virtueller Maschinen verbessern und viele Funktionen 
                        für die einfache Verwaltung von Gastbetriebssystemen bereitstellen.</p>
                        
                        <p><strong>Mögliche Status der VMware Tools:</strong></p>
                        <ul>
                            <li><span class="badge bg-success">OK</span> - VMware Tools sind installiert und auf dem neuesten Stand</li>
                            <li><span class="badge bg-warning">Veraltet</span> - VMware Tools sind installiert, aber nicht auf dem neuesten Stand</li>
                            <li><span class="badge bg-danger">Nicht installiert</span> - VMware Tools sind nicht installiert</li>
                            <li><span class="badge bg-secondary">Wird nicht ausgeführt</span> - VMware Tools sind installiert, werden aber nicht ausgeführt</li>
                        </ul>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-lightbulb"></i> <strong>Tipp:</strong> Es wird empfohlen, VMware Tools stets auf dem neuesten Stand zu halten, 
                            um von allen Funktionen und Sicherheitsverbesserungen zu profitieren.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    {% if vmware_tools %}
    <div class="table-responsive">
        <table class="table table-striped datatable">
            <thead>
                <tr>
                    <th>Virtuelle Maschine</th>
                    <th>Status</th>
                    <th>Version</th>
                    <th>Betriebssystem</th>
                    <th>Power-Status</th>
                    <th>Host</th>
                </tr>
            </thead>
            <tbody>
                {% for vm in vmware_tools %}
                <tr>
                    <td>{{ vm.name }}</td>
                    <td>
                        {% if vm.tools_status == "toolsOk" %}
                            <span class="badge bg-success">OK</span>
                        {% elif vm.tools_status == "toolsOld" %}
                            <span class="badge bg-warning">Veraltet</span>
                        {% elif vm.tools_status == "toolsNotInstalled" %}
                            <span class="badge bg-danger">Nicht installiert</span>
                        {% elif vm.tools_status == "toolsNotRunning" %}
                            <span class="badge bg-secondary">Wird nicht ausgeführt</span>
                        {% else %}
                            <span class="badge bg-secondary">Unbekannt</span>
                        {% endif %}
                    </td>
                    <td>{{ vm.version|default("Nicht verfügbar") }}</td>
                    <td>{{ vm.guest_full_name|default("Unbekannt") }}</td>
                    <td>
                        {% if vm.power_state == "poweredOn" %}
                            <span class="text-success"><i class="fas fa-power-off"></i> An</span>
                        {% else %}
                            <span class="text-secondary"><i class="fas fa-power-off"></i> Aus</span>
                        {% endif %}
                    </td>
                    <td>{{ vm.host }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Statistik-Kacheln -->
    <div class="row mt-4">
        {% set ok_count = vmware_tools|selectattr("tools_status", "eq", "toolsOk")|list|length %}
        {% set old_count = vmware_tools|selectattr("tools_status", "eq", "toolsOld")|list|length %}
        {% set not_installed_count = vmware_tools|selectattr("tools_status", "eq", "toolsNotInstalled")|list|length %}
        {% set not_running_count = vmware_tools|selectattr("tools_status", "eq", "toolsNotRunning")|list|length %}
        {% set total_count = vmware_tools|length %}
        
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body bg-success text-white">
                    <h3 class="card-title">{{ ok_count }}</h3>
                    <p class="card-text">Aktuelle Version</p>
                </div>
                <div class="card-footer">
                    {{ ((ok_count / total_count) * 100)|round(1) }}%
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body bg-warning">
                    <h3 class="card-title">{{ old_count }}</h3>
                    <p class="card-text">Veraltet</p>
                </div>
                <div class="card-footer">
                    {{ ((old_count / total_count) * 100)|round(1) }}%
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body bg-danger text-white">
                    <h3 class="card-title">{{ not_installed_count }}</h3>
                    <p class="card-text">Nicht installiert</p>
                </div>
                <div class="card-footer">
                    {{ ((not_installed_count / total_count) * 100)|round(1) }}%
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body bg-secondary text-white">
                    <h3 class="card-title">{{ not_running_count }}</h3>
                    <p class="card-text">Nicht ausgeführt</p>
                </div>
                <div class="card-footer">
                    {{ ((not_running_count / total_count) * 100)|round(1) }}%
                </div>
            </div>
        </div>
    </div>
    
    <div class="mt-4">
        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Zurück zum Dashboard
        </a>
        <a href="{{ url_for('generate_report') }}" class="btn btn-primary">
            <i class="fas fa-file-export"></i> Bericht erstellen
        </a>
    </div>
    
    {% else %}
    <div class="alert alert-info">
        <i class="fas fa-info-circle"></i> Keine Daten für VMware Tools Status verfügbar.
    </div>
    
    <div class="mt-4">
        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Zurück zum Dashboard
        </a>
    </div>
    {% endif %}
</div>

{% if demo_mode %}
<div class="alert alert-warning mt-4">
    <i class="fas fa-info-circle"></i> <strong>Demo-Modus:</strong> Die angezeigten Daten sind Beispieldaten und spiegeln keine echte vSphere-Umgebung wider.
</div>
{% endif %}

{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
<script>
    $(document).ready(function() {
        $('.datatable').DataTable({
            "language": {
                "url": "//cdn.datatables.net/plug-ins/1.11.5/i18n/de-DE.json"
            },
            "pageLength": 25,
            "order": [[1, "asc"]] // Sortiere nach Status (Spalte 1)
        });
    });
</script>
{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
{% endblock %}