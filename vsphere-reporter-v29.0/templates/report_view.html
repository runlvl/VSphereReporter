{% extends "base.html" %}

{% block title %}VMware vSphere Reporter - Bericht anzeigen{% endblock %}

{% block extra_head %}
<style>
    .report-container {
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }
    
    .report-header {
        background-color: var(--bechtle-dark-blue);
        color: white;
        padding: 20px;
        margin: 0;
    }
    
    .report-body {
        padding: 20px;
    }
    
    .report-section {
        margin-bottom: 30px;
    }
    
    .section-title {
        color: var(--bechtle-dark-blue);
        border-bottom: 2px solid var(--bechtle-orange);
        padding-bottom: 10px;
        margin-bottom: 20px;
    }
    
    .summary-card {
        border-left: 4px solid var(--bechtle-dark-blue);
        background-color: rgba(0, 53, 94, 0.05);
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
    }
    
    .summary-item {
        margin-bottom: 5px;
    }
    
    .warning-item {
        border-left: 4px solid var(--bechtle-orange);
        background-color: rgba(218, 111, 30, 0.1);
    }
    
    .success-item {
        border-left: 4px solid var(--bechtle-green);
        background-color: rgba(35, 169, 106, 0.1);
    }
    
    .report-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
    }
    
    .report-table th {
        background-color: var(--bechtle-dark-blue);
        color: white;
        text-align: left;
        padding: 10px;
    }
    
    .report-table tr:nth-child(even) {
        background-color: #f3f3f3;
    }
    
    .report-table td {
        padding: 8px 10px;
        border-bottom: 1px solid #ddd;
    }
    
    .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
    }
    
    .status-ok {
        background-color: var(--bechtle-green);
    }
    
    .status-warning {
        background-color: var(--bechtle-orange);
    }
    
    .status-error {
        background-color: #dc3545;
    }
    
    .topologie-container {
        height: 600px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-bottom: 20px;
    }
    
    .info-box {
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 15px;
    }
    
    .info-blue {
        background-color: rgba(0, 53, 94, 0.1);
    }
    
    .info-orange {
        background-color: rgba(218, 111, 30, 0.1);
    }
    
    .tab-content {
        padding-top: 20px;
    }
    
    .nav-tabs .nav-link {
        color: var(--bechtle-dark-gray);
    }
    
    .nav-tabs .nav-link.active {
        color: var(--bechtle-dark-blue);
        font-weight: 600;
        border-bottom: 3px solid var(--bechtle-dark-blue);
    }
</style>
{% endblock %}

{% block content %}
<div class="report-container mb-4">
    <div class="report-header">
        <div class="row align-items-center">
            <div class="col-md-9">
                <h2>VMware vSphere Infrastruktur-Bericht</h2>
                <p class="mb-0">Generiert am {{ report_data.generated_at | default('01.01.2025, 00:00 Uhr') }}</p>
            </div>
            <div class="col-md-3 text-md-end">
                <div class="btn-group">
                    <a href="{{ url_for('download_report', report_id=report_id, format='html') }}" class="btn btn-light">
                        <i class="fas fa-download me-2"></i>Herunterladen
                    </a>
                    <button type="button" class="btn btn-light dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
                        <span class="visually-hidden">Menü öffnen</span>
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="{{ url_for('download_report', report_id=report_id, format='html') }}">
                            <i class="fas fa-file-code me-2"></i>HTML
                        </a></li>
                        <li><a class="dropdown-item" href="{{ url_for('download_report', report_id=report_id, format='pdf') }}">
                            <i class="fas fa-file-pdf me-2"></i>PDF
                        </a></li>
                        <li><a class="dropdown-item" href="{{ url_for('download_report', report_id=report_id, format='docx') }}">
                            <i class="fas fa-file-word me-2"></i>DOCX
                        </a></li>
                    </ul>
                </div>
                
                <a href="{{ url_for('options') }}" class="btn btn-outline-light ms-2">
                    <i class="fas fa-sync-alt me-2"></i>Neuer Bericht
                </a>
            </div>
        </div>
    </div>
    
    <div class="report-body">
        <!-- Zusammenfassung -->
        <div class="report-section">
            <h3 class="section-title">Zusammenfassung</h3>
            
            <div class="row">
                <div class="col-md-4 mb-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title"><i class="fas fa-server me-2"></i>VMs</h5>
                            <h2 class="display-4 mb-3">{{ report_data.summary.vm_count | default('42') }}</h2>
                            <div class="text-muted">Aktive VMs: {{ report_data.summary.powered_on_vms | default('38') }}</div>
                            <div class="text-muted">Ausgeschaltete VMs: {{ report_data.summary.powered_off_vms | default('4') }}</div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4 mb-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title"><i class="fas fa-hdd me-2"></i>Speicher</h5>
                            <h2 class="display-4 mb-3">{{ report_data.summary.total_storage | default('8.2 TB') }}</h2>
                            <div class="text-muted">Verwendet: {{ report_data.summary.used_storage | default('5.7 TB (69%)') }}</div>
                            <div class="text-muted">Frei: {{ report_data.summary.free_storage | default('2.5 TB (31%)') }}</div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4 mb-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title"><i class="fas fa-microchip me-2"></i>Hosts</h5>
                            <h2 class="display-4 mb-3">{{ report_data.summary.host_count | default('4') }}</h2>
                            <div class="text-muted">Prozessoren: {{ report_data.summary.total_cpus | default('96 Kerne') }}</div>
                            <div class="text-muted">Arbeitsspeicher: {{ report_data.summary.total_memory | default('768 GB') }}</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row mt-3">
                <div class="col-12">
                    <div class="summary-card">
                        <h5><i class="fas fa-exclamation-triangle me-2 text-warning"></i>Wichtige Hinweise</h5>
                        
                        <div class="summary-item warning-item p-2 mb-2">
                            <strong>VMware Tools:</strong> {{ report_data.summary.outdated_vmware_tools | default('5 VMs') }} haben veraltete oder nicht installierte VMware Tools
                        </div>
                        
                        <div class="summary-item warning-item p-2 mb-2">
                            <strong>Snapshots:</strong> {{ report_data.summary.old_snapshots | default('3 Snapshots') }} sind älter als 30 Tage
                        </div>
                        
                        <div class="summary-item warning-item p-2">
                            <strong>Verwaiste VMDKs:</strong> {{ report_data.summary.orphaned_vmdks | default('7 potenziell verwaiste VMDK-Dateien') }} gefunden ({{ report_data.summary.orphaned_vmdks_size | default('243 GB') }})
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tabs für Berichtsabschnitte -->
        <ul class="nav nav-tabs" id="reportTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="vmware-tools-tab" data-bs-toggle="tab" data-bs-target="#vmware-tools" type="button" role="tab" aria-controls="vmware-tools" aria-selected="true">
                    VMware Tools
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="snapshots-tab" data-bs-toggle="tab" data-bs-target="#snapshots" type="button" role="tab" aria-controls="snapshots" aria-selected="false">
                    Snapshots
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="orphaned-vmdks-tab" data-bs-toggle="tab" data-bs-target="#orphaned-vmdks" type="button" role="tab" aria-controls="orphaned-vmdks" aria-selected="false">
                    Verwaiste VMDKs
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="vms-tab" data-bs-toggle="tab" data-bs-target="#vms" type="button" role="tab" aria-controls="vms" aria-selected="false">
                    VMs
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="hosts-tab" data-bs-toggle="tab" data-bs-target="#hosts" type="button" role="tab" aria-controls="hosts" aria-selected="false">
                    Hosts
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="datastores-tab" data-bs-toggle="tab" data-bs-target="#datastores" type="button" role="tab" aria-controls="datastores" aria-selected="false">
                    Datastores
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="topology-tab" data-bs-toggle="tab" data-bs-target="#topology" type="button" role="tab" aria-controls="topology" aria-selected="false">
                    Topologie
                </button>
            </li>
        </ul>
        
        <div class="tab-content" id="reportTabsContent">
            <!-- VMware Tools Tab -->
            <div class="tab-pane fade show active" id="vmware-tools" role="tabpanel" aria-labelledby="vmware-tools-tab">
                <div class="report-section">
                    <h4>VMware Tools Status</h4>
                    <p>Dieser Abschnitt zeigt den Status der VMware Tools auf allen virtuellen Maschinen, sortiert nach Alter.</p>
                    
                    <div class="info-box info-blue">
                        <h5><i class="fas fa-info-circle me-2"></i>Warum ist das wichtig?</h5>
                        <p class="mb-0">
                            Aktuelle VMware Tools verbessern die Performance und Stabilität der virtuellen Maschinen. 
                            Veraltete oder fehlende Tools können zu Funktionseinschränkungen führen (z.B. fehlendes Drag-and-Drop, 
                            keine automatische Bildschirmanpassung, keine VM-Statistikdaten).
                        </p>
                    </div>
                    
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>VM-Name</th>
                                <th>VMware Tools Version</th>
                                <th>Status</th>
                                <th>Letzte Aktualisierung</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>app-server-01</td>
                                <td>10.3.5</td>
                                <td><span class="status-indicator status-warning"></span>Veraltet</td>
                                <td>15.03.2024</td>
                            </tr>
                            <tr>
                                <td>db-server-prod</td>
                                <td>12.1.0</td>
                                <td><span class="status-indicator status-ok"></span>Aktuell</td>
                                <td>02.04.2025</td>
                            </tr>
                            <tr>
                                <td>web-server-02</td>
                                <td>11.2.5</td>
                                <td><span class="status-indicator status-warning"></span>Veraltet</td>
                                <td>10.07.2024</td>
                            </tr>
                            <tr>
                                <td>legacy-app-01</td>
                                <td>9.4.0</td>
                                <td><span class="status-indicator status-error"></span>Stark veraltet</td>
                                <td>05.05.2023</td>
                            </tr>
                            <tr>
                                <td>test-vm-03</td>
                                <td>Nicht installiert</td>
                                <td><span class="status-indicator status-error"></span>Nicht installiert</td>
                                <td>--</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Snapshots Tab -->
            <div class="tab-pane fade" id="snapshots" role="tabpanel" aria-labelledby="snapshots-tab">
                <div class="report-section">
                    <h4>VM-Snapshots</h4>
                    <p>Übersicht aller Snapshots in der Umgebung, sortiert nach Alter (älteste zuerst).</p>
                    
                    <div class="info-box info-orange">
                        <h5><i class="fas fa-exclamation-triangle me-2"></i>Achtung</h5>
                        <p class="mb-0">
                            Snapshots sollten nur temporär verwendet werden. Alte Snapshots können zu Performanceproblemen 
                            führen und unnötig Speicherplatz belegen. Es wird empfohlen, Snapshots nach der Verwendung zeitnah 
                            zu löschen oder in die Basis-VMDK zu überführen.
                        </p>
                    </div>
                    
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>VM-Name</th>
                                <th>Snapshot-Name</th>
                                <th>Erstellt am</th>
                                <th>Alter</th>
                                <th>Größe</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>db-server-dev</td>
                                <td>Vor Datenbank-Update</td>
                                <td>01.02.2025</td>
                                <td>93 Tage</td>
                                <td>45 GB</td>
                            </tr>
                            <tr>
                                <td>app-server-test</td>
                                <td>Test neue Version</td>
                                <td>15.02.2025</td>
                                <td>79 Tage</td>
                                <td>12 GB</td>
                            </tr>
                            <tr>
                                <td>web-frontend-01</td>
                                <td>Vor Design-Update</td>
                                <td>02.03.2025</td>
                                <td>64 Tage</td>
                                <td>8 GB</td>
                            </tr>
                            <tr>
                                <td>auth-server-01</td>
                                <td>Sicherung vor Patch</td>
                                <td>10.04.2025</td>
                                <td>25 Tage</td>
                                <td>18 GB</td>
                            </tr>
                            <tr>
                                <td>monitoring-01</td>
                                <td>Konfigurationsänderung</td>
                                <td>25.04.2025</td>
                                <td>10 Tage</td>
                                <td>3 GB</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Verwaiste VMDKs Tab -->
            <div class="tab-pane fade" id="orphaned-vmdks" role="tabpanel" aria-labelledby="orphaned-vmdks-tab">
                <div class="report-section">
                    <h4>Verwaiste VMDK-Dateien</h4>
                    <p>Diese VMDKs sind möglicherweise nicht mehr mit einer VM verbunden und verschwenden Speicherplatz.</p>
                    
                    <div class="info-box info-blue">
                        <h5><i class="fas fa-info-circle me-2"></i>Was sind verwaiste VMDKs?</h5>
                        <p class="mb-0">
                            Verwaiste VMDK-Dateien sind virtuelle Festplatten, die keiner aktiven VM zugeordnet sind. 
                            Sie entstehen meist durch fehlerhafte VM-Löschungen oder manuelles Entfernen von Disks ohne 
                            Löschen der zugehörigen Dateien. Diese Dateien belegen wertvollen Speicherplatz.
                        </p>
                    </div>
                    
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>Datastore</th>
                                <th>Pfad</th>
                                <th>Größe</th>
                                <th>Letzte Änderung</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>ds-san-01</td>
                                <td>[ds-san-01] old_vms/app_server_2023.vmdk</td>
                                <td>80 GB</td>
                                <td>12.08.2024</td>
                                <td><span class="badge bg-warning">POTENZIELL VERWAIST</span></td>
                            </tr>
                            <tr>
                                <td>ds-san-02</td>
                                <td>[ds-san-02] migration/db_backup_disk.vmdk</td>
                                <td>120 GB</td>
                                <td>05.10.2024</td>
                                <td><span class="badge bg-warning">POTENZIELL VERWAIST</span></td>
                            </tr>
                            <tr>
                                <td>ds-ssd-01</td>
                                <td>[ds-ssd-01] tmp/temp_disk_01.vmdk</td>
                                <td>15 GB</td>
                                <td>23.01.2025</td>
                                <td><span class="badge bg-warning">POTENZIELL VERWAIST</span></td>
                            </tr>
                            <tr>
                                <td>ds-san-01</td>
                                <td>[ds-san-01] archive/old_project_files.vmdk</td>
                                <td>45 GB</td>
                                <td>17.11.2024</td>
                                <td><span class="badge bg-warning">POTENZIELL VERWAIST</span></td>
                            </tr>
                            <tr>
                                <td>ds-ssd-02</td>
                                <td>[ds-ssd-02] deleted_vms/web_server_old.vmdk</td>
                                <td>25 GB</td>
                                <td>03.03.2025</td>
                                <td><span class="badge bg-warning">POTENZIELL VERWAIST</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- VM-Liste Tab -->
            <div class="tab-pane fade" id="vms" role="tabpanel" aria-labelledby="vms-tab">
                <div class="report-section">
                    <h4>Virtuelle Maschinen</h4>
                    <p>Übersicht aller virtuellen Maschinen in der vSphere-Umgebung.</p>
                    
                    <!-- Hier würde die Liste der VMs angezeigt -->
                </div>
            </div>
            
            <!-- Hosts Tab -->
            <div class="tab-pane fade" id="hosts" role="tabpanel" aria-labelledby="hosts-tab">
                <div class="report-section">
                    <h4>ESXi-Hosts</h4>
                    <p>Informationen zu allen ESXi-Hosts in der Umgebung.</p>
                    
                    <!-- Hier würden die Host-Informationen angezeigt -->
                </div>
            </div>
            
            <!-- Datastores Tab -->
            <div class="tab-pane fade" id="datastores" role="tabpanel" aria-labelledby="datastores-tab">
                <div class="report-section">
                    <h4>Datastores</h4>
                    <p>Übersicht aller Datastores und deren Auslastung.</p>
                    
                    <!-- Hier würden die Datastore-Informationen angezeigt -->
                </div>
            </div>
            
            <!-- Topologie Tab -->
            <div class="tab-pane fade" id="topology" role="tabpanel" aria-labelledby="topology-tab">
                <div class="report-section">
                    <h4>Infrastruktur-Topologie</h4>
                    <p>Visualisierung der vSphere-Infrastruktur und der Beziehungen zwischen den Komponenten.</p>
                    
                    <div class="topologie-container">
                        <!-- Hier würde das interaktive Topologie-Diagramm angezeigt -->
                        <div class="d-flex justify-content-center align-items-center h-100">
                            <div class="text-center">
                                <div class="spinner-border text-primary mb-3" role="status">
                                    <span class="visually-hidden">Wird geladen...</span>
                                </div>
                                <p>Topologie-Diagramm wird geladen...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // Beispielcode für ein interaktives Topologie-Diagramm
        // In der echten Implementierung würde hier das pyecharts-Diagramm angezeigt
        
        // Simulation des Ladevorgangs für die Demo
        setTimeout(function() {
            $('.topologie-container').html('<iframe src="{{ url_for("static", filename="topology/example_topology.html") }}" width="100%" height="100%" frameborder="0"></iframe>');
        }, 2000);
    });
</script>
{% endblock %}