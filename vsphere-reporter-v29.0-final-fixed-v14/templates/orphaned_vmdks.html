{% extends "base.html" %}

{% block title %}Verwaiste VMDKs - VMware vSphere Reporter{% endblock %}

{% block content %}
<h1 class="my-4">Verwaiste VMDK-Dateien</h1>

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <input type="text" id="vmdks-filter" class="form-control table-filter" placeholder="Suche..." data-target="vmdks-table">
    </div>
    <div>
        {% set total_size = orphaned_vmdks_data|sum(attribute='size_bytes') / (1024 * 1024 * 1024) %}
        <span class="badge bg-warning">Anzahl: {{ orphaned_vmdks_data|length }}</span>
        <span class="badge bg-danger">Gesamtgröße: {{ "%.2f"|format(total_size) }} GB</span>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-bordered sortable" id="vmdks-table">
        <thead>
            <tr class="table-dark">
                <th data-sort="name">Dateiname</th>
                <th data-sort="datastore">Datastore</th>
                <th data-sort="size">Größe</th>
                <th data-sort="action">Empfohlene Aktion</th>
            </tr>
        </thead>
        <tbody>
            {% for vmdk in orphaned_vmdks_data %}
            {% set row_class = "" %}
            {% if vmdk.size_bytes|default(0) > 100 * 1024 * 1024 * 1024 %}
                {% set row_class = "table-danger" %}
            {% elif vmdk.size_bytes|default(0) > 50 * 1024 * 1024 * 1024 %}
                {% set row_class = "table-warning" %}
            {% else %}
                {% set row_class = "table-info" %}
            {% endif %}
            <tr class="{{ row_class }}">
                <td data-name="{{ vmdk.name }}">{{ vmdk.name }}</td>
                <td data-datastore="{{ vmdk.datastore }}">{{ vmdk.datastore }}</td>
                <td data-size="{{ vmdk.size_bytes|default(0) }}">{{ vmdk.size_human|default('Unbekannt') }}</td>
                <td data-action="{{ vmdk.recommended_action|default('') }}">{{ vmdk.recommended_action|default('Manuelle Überprüfung erforderlich') }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="card mt-4">
    <div class="card-header">Hinweise zu verwaisten VMDK-Dateien</div>
    <div class="card-body">
        <p>Verwaiste VMDK-Dateien sind Festplattendateien, die keiner virtuellen Maschine mehr zugeordnet sind. Sie können durch unvollständige Löschvorgänge, Probleme bei VM-Migrationen oder fehlerhafte Snapshot-Vorgänge entstehen.</p>
        
        <h5 class="mt-3">Definition: Was ist eine verwaiste VMDK?</h5>
        <p>Eine VMDK-Datei wird als "verwaist" betrachtet, wenn sie:</p>
        <ul>
            <li>In der vSphere-Umgebung existiert, aber keiner aktiven VM zugeordnet ist</li>
            <li>Nicht zu einem Template gehört</li>
            <li>Nicht Teil einer Snapshot-Kette ist</li>
            <li>Nicht als ISO-Datei oder andere CD/DVD-Abbilddatei verwendet wird</li>
        </ul>
        
        <h5 class="mt-3">Empfehlungen:</h5>
        <ol>
            <li>Überprüfen Sie jede VMDK-Datei sorgfältig, bevor Sie sie löschen.</li>
            <li>Erstellen Sie bei Unsicherheit eine Sicherungskopie der VMDK.</li>
            <li>Verfolgen Sie die Herkunft der VMDK zurück, um sicherzustellen, dass sie wirklich nicht benötigt wird.</li>
            <li>Löschen Sie die VMDK erst, wenn Sie die Notwendigkeit überprüft haben.</li>
        </ol>
        
        <div class="alert alert-warning">
            <strong>Achtung:</strong> Das Löschen einer verwaisten VMDK ist endgültig und kann nicht rückgängig gemacht werden. Gehen Sie mit äußerster Vorsicht vor.
        </div>
    </div>
</div>
{% endblock %}